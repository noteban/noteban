name: Update Nix Hash

on:
  release:
    types: [published]

jobs:
  update-hash:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get version from release tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Download AppImage and compute hash
        id: hash
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          URL="https://github.com/noteban/noteban/releases/download/v${VERSION}/Noteban_${VERSION}_amd64.AppImage"

          echo "Downloading AppImage from: $URL"
          curl -L -o noteban.AppImage "$URL"

          # Compute SHA256 and convert to SRI format (base64)
          SHA256=$(sha256sum noteban.AppImage | cut -d' ' -f1)
          SRI_HASH="sha256-$(echo "$SHA256" | xxd -r -p | base64 -w 0)"

          echo "SHA256: $SHA256"
          echo "SRI Hash: $SRI_HASH"
          echo "SRI_HASH=$SRI_HASH" >> $GITHUB_OUTPUT

      - name: Update nix/default.nix
        run: |
          SRI_HASH="${{ steps.hash.outputs.SRI_HASH }}"

          # Update the hash in default.nix
          sed -i "s|hash = \"sha256-[^\"]*\"|hash = \"$SRI_HASH\"|" nix/default.nix

          echo "Updated nix/default.nix:"
          grep -A1 "fetchurl" nix/default.nix

      - name: Commit and push
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add nix/default.nix
          git diff --staged --quiet || git commit -m "Update Nix package hash for v${VERSION}"
          git push origin main
